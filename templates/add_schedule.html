<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>添加排课 - 课消平台</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .select2-container--default .select2-selection--multiple {
            min-height: 38px;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
        }
        .select2-container--default .select2-selection--single {
            height: 38px;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
        }
        .select2-selection__choice {
            color: #fff;
            background: #0d6efd;
            border: none;
            margin-top: 4px;
        }
        .table-schedule th, .table-schedule td {
            vertical-align: middle;
            padding: 0.5rem 0.75rem;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h1>{{ '编辑排课' if edit else '添加排课' }}</h1>
    <form method="post">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="course_id" class="form-label">课程</label>
                <select class="form-select" id="course_id" name="course_id" required>
                    <option value="">请选择课程</option>
                    <option value="C++">C++</option>
                    <option value="GOC">GOC</option>
                    <option value="图形化">图形化</option>
                    <option value="other">其他</option>
                </select>
                <input type="text" class="form-control mt-2" id="custom_course" name="custom_course" placeholder="请输入课程名称" style="display:none;">
            </div>
            <div class="col-md-8">
                <label for="student_ids" class="form-label">学生（可多选）</label>
                <div class="d-flex align-items-center">
                    <select class="form-select" id="student_ids" name="student_ids" multiple required style="width: 100%;">
                        {% for student in students %}
                        <option value="{{ student.id }}" data-courses="{{ student.courses|join(',') }}" {% if schedule and (student.id|string) in (schedule.student_ids.split(',')) %}selected{% endif %}>{{ student.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="selectAll">全选</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="deselectAll">全不选</button>
                </div>
                <small class="form-text text-muted">可搜索、全选/全不选，课程联动筛选</small>
            </div>
        </div>
        <div class="row g-3 mt-2">
            <div class="col-md-4">
                <label for="teacher" class="form-label">上课老师</label>
                <input type="text" class="form-control" id="teacher" name="teacher" value="{{ schedule.teacher if schedule else '' }}">
            </div>
            <div class="col-md-4">
                <label for="start_date" class="form-label">开始日期</label>
                <input type="date" class="form-control" id="start_date" name="start_date" value="{{ schedule.start_date if schedule else '' }}" required>
            </div>
            <div class="col-md-4">
                <label for="end_date" class="form-label">结束日期</label>
                <input type="date" class="form-control" id="end_date" name="end_date" value="{{ schedule.end_date if schedule else '' }}" required>
            </div>
            <div class="col-md-4">
                <label for="time" class="form-label">时间</label>
                <input type="time" class="form-control" id="time" name="time" value="{{ schedule.time if schedule else '' }}">
            </div>
        </div>
        <div class="mb-3 mt-2">
            <label for="note" class="form-label">备注</label>
            <input type="text" class="form-control" id="note" name="note" value="{{ schedule.note if schedule else '' }}">
        </div>
        <button type="submit" class="btn btn-success">提交</button>
        <a href="{{ url_for('schedule_list') }}" class="btn btn-secondary ms-2">返回</a>
    </form>
</div>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    // 初始化select2
    $('#student_ids').select2({
        placeholder: '请选择学生',
        allowClear: true,
        width: 'resolve',
    });
    // 课程选择逻辑
    $('#course_id').on('change', function() {
        var val = $(this).val();
        if(val === 'other') {
            $('#custom_course').show().attr('required', true);
        } else {
            $('#custom_course').hide().val('').removeAttr('required');
        }
        // 联动筛选学生
        $('#student_ids option').each(function() {
            var courses = $(this).data('courses') ? $(this).data('courses').toString().split(',') : [];
            if (!val || courses.includes(val.toString())) {
                $(this).show();
            } else {
                $(this).prop('selected', false).hide();
            }
        });
        $('#student_ids').trigger('change.select2');
    });
    // 全选/全不选
    $('#selectAll').click(function() {
        $('#student_ids option:visible').prop('selected', true);
        $('#student_ids').trigger('change');
    });
    $('#deselectAll').click(function() {
        $('#student_ids option').prop('selected', false);
        $('#student_ids').trigger('change');
    });
});
</script>
</body>
</html> 